pipeline {
    agent any

    tools {
        maven 'MavenDefault'
        jdk 'JDKDefault'
    }

    environment {
        SPRING_PROFILES_ACTIVE = 'dev'
    }

     stages {
            stage('Java Version') {
                steps {
                    bat 'java -version'
                }
            }

            stage('Start Containers') {
                        steps {
                            bat 'docker-compose up -d postgres elasticsearch keycloak'
                            bat 'timeout 60 > NUL' // AÈ™tept sa porneasca
                            bat 'docker-compose exec elasticsearch curl --retry 10 --retry-delay 5 -s -f http://localhost:9200/_cluster/health || exit 1'
                        }
                    }

            stage('Build') {
                steps {
                    dir('book-network') {
                        bat 'mvn clean package -DskipTests'
                    }
                }
            }

            stage('Test') {
                steps {
                    dir('book-network') {
                        bat 'mvn test'
                    }
                }
            }

            stage('Build Docker Image') {
                        steps {
                            dir('book-network') {
                                bat 'docker build -t bsn-api:1.0.0 .'
                            }
                        }
            }

            stage('Archive JAR') {
                steps {
                    dir('book-network') {
                        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                    }
                }
            }
     }
}
